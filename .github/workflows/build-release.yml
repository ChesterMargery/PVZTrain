---
name: Build and Release PVZTrain

'on':
  push:
    branches: [master, main]
    tags:
      - 'v*'
  pull_request:
    branches: [master, main]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSVC (32-bit)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x86

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          if (Test-Path requirements.txt) {
            pip install -r requirements.txt
            if ($LASTEXITCODE -ne 0) {
              throw "Failed to install Python dependencies"
            }
          } else {
            Write-Warning "requirements.txt not found, skipping"
          }
        shell: pwsh

      - name: Configure CMake
        working-directory: hook
        run: |
          New-Item -ItemType Directory -Force -Path build | Out-Null
          Set-Location build
          cmake -G "Visual Studio 17 2022" -A Win32 ..
        shell: pwsh

      - name: Build DLL (Release)
        working-directory: hook/build
        run: cmake --build . --config Release

      - name: Prepare Release Package
        shell: pwsh
        run: |
          # 创建发布目录
          New-Item -ItemType Directory -Force -Path release/PVZTrain

          # 复制编译好的DLL
          Copy-Item hook/build/Release/pvz_hook.dll release/PVZTrain/ `
            -ErrorAction Stop

          # 复制Python模块（必需目录）
          $requiredDirs = @(
            'core', 'hook_client', 'memory', 'game',
            'data', 'engine', 'utils', 'tools', 'examples'
          )
          foreach ($dir in $requiredDirs) {
            if (Test-Path $dir) {
              Copy-Item -Recurse $dir release/PVZTrain/
            } else {
              Write-Warning "Directory $dir not found, skipping"
            }
          }

          # 复制配置和文档（必需文件）
          $requiredFiles = @(
            'main.py', 'config.py', 'requirements.txt',
            'README.md', 'LICENSE', 'HOOK_MIGRATION.md'
          )
          foreach ($file in $requiredFiles) {
            if (Test-Path $file) {
              Copy-Item $file release/PVZTrain/
            } else {
              Write-Warning "File $file not found, skipping"
            }
          }

          # 复制启动脚本
          $batchFiles = @('一键启动.bat', '启动说明.bat')
          foreach ($file in $batchFiles) {
            if (Test-Path $file) {
              Copy-Item $file release/PVZTrain/
            } else {
              Write-Warning "Batch file $file not found, skipping"
            }
          }

      - name: Create ZIP Archive
        shell: pwsh
        run: |
          # Use commit SHA for non-tag builds, tag name for releases
          if ("${{ github.ref_type }}" -eq "tag") {
            $version = "${{ github.ref_name }}"
          } else {
            $version = "${{ github.sha }}".Substring(0, 7)
          }
          $zipName = "PVZTrain-${version}.zip"
          Compress-Archive -Path release/PVZTrain/* -DestinationPath $zipName

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PVZTrain-Package
          path: PVZTrain-*.zip
          retention-days: 30

      - name: Upload DLL Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pvz_hook-dll
          path: hook/build/Release/pvz_hook.dll
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Download Package Artifact
        uses: actions/download-artifact@v4
        with:
          name: PVZTrain-Package

      - name: Download DLL Artifact
        uses: actions/download-artifact@v4
        with:
          name: pvz_hook-dll

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            PVZTrain-*.zip
            pvz_hook.dll
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
