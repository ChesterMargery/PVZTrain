---
name: Build and Release PVZTrain

'on':
  push:
    branches: [master, main]
    tags:
      - 'v*'
  pull_request:
    branches: [master, main]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSVC (32-bit)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x86

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          if (Test-Path requirements.txt) {
            pip install -r requirements.txt
          } else {
            Write-Warning "requirements.txt not found, skipping"
          }
        shell: pwsh

      - name: Configure CMake
        working-directory: hook
        run: |
          mkdir build
          cd build
          cmake -G "Visual Studio 17 2022" -A Win32 ..

      - name: Build DLL (Release)
        working-directory: hook/build
        run: cmake --build . --config Release

      - name: Prepare Release Package
        shell: pwsh
        run: |
          # 创建发布目录
          New-Item -ItemType Directory -Force -Path release/PVZTrain

          # 复制编译好的DLL
          Copy-Item hook/build/Release/pvz_hook.dll release/PVZTrain/

          # 复制Python模块
          Copy-Item -Recurse core release/PVZTrain/
          Copy-Item -Recurse hook_client release/PVZTrain/
          Copy-Item -Recurse memory release/PVZTrain/
          Copy-Item -Recurse game release/PVZTrain/
          Copy-Item -Recurse data release/PVZTrain/
          Copy-Item -Recurse engine release/PVZTrain/
          Copy-Item -Recurse utils release/PVZTrain/
          Copy-Item -Recurse tools release/PVZTrain/
          Copy-Item -Recurse examples release/PVZTrain/

          # 复制配置和文档
          Copy-Item main.py release/PVZTrain/
          Copy-Item config.py release/PVZTrain/
          Copy-Item requirements.txt release/PVZTrain/
          Copy-Item README.md release/PVZTrain/
          Copy-Item LICENSE release/PVZTrain/
          Copy-Item HOOK_MIGRATION.md release/PVZTrain/

          # 复制启动脚本
          Copy-Item "一键启动.bat" release/PVZTrain/
          Copy-Item "启动说明.bat" release/PVZTrain/

      - name: Create ZIP Archive
        shell: pwsh
        run: |
          # Use commit SHA for non-tag builds, tag name for releases
          if ("${{ github.ref_type }}" -eq "tag") {
            $version = "${{ github.ref_name }}"
          } else {
            $version = "${{ github.sha }}".Substring(0, 7)
          }
          $zipName = "PVZTrain-${version}.zip"
          Compress-Archive -Path release/PVZTrain/* `
            -DestinationPath $zipName

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PVZTrain-Package
          path: PVZTrain-*.zip
          retention-days: 30

      - name: Upload DLL Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pvz_hook-dll
          path: hook/build/Release/pvz_hook.dll
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download Package Artifact
        uses: actions/download-artifact@v4
        with:
          name: PVZTrain-Package

      - name: Download DLL Artifact
        uses: actions/download-artifact@v4
        with:
          name: pvz_hook-dll

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            PVZTrain-*.zip
            pvz_hook.dll
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
